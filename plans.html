<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Plans - Rwanda Connekt</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .plans-container{
      max-width:1100px;
      margin:3rem auto;
      padding:2.5rem 2rem;
      background: linear-gradient(120deg, #1e293b 60%, #eab308 100%);
      border-radius: 18px;
      box-shadow: 0 6px 32px 0 rgba(44, 62, 80, 0.18);
    }
    .plans-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem}
    .plan{background:rgba(39,39,42,0.9);padding:1.5rem;border-radius:12px;border:1px solid rgba(255,255,255,0.06)}
    .plan h3{color:#fff;margin-bottom:0.5rem}
    .plan p{color:#ccc}
    .pay-methods{display:flex;gap:0.5rem;margin-top:1rem}
    .pay-btn{padding:0.6rem 0.9rem;border-radius:8px;border:none;cursor:pointer}
    .momo{background:linear-gradient(135deg,#009B3A,#FFCD00);color:#000}
    .card{background:linear-gradient(135deg,#1f2937,#374151);color:#fff}
    .disabled{opacity:0.6}
    @media(max-width:900px){.plans-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <nav>
      <div class="nav-logo">
            <a href="index.html" class="brand-image" aria-label="Rwanda Connekt home">
                <img src="images/logo__2.png" alt="Rwanda Connekt Logo" class="brand-image">
                
            </a>
        </div>
    <a href="index.html" class="btn">Back Home</a>
  </nav>

  <main class="container plans-container">
    <h1 style="color:#fff;margin-bottom:1rem">Choose a Plan</h1>
    <p style="color:#ccc;margin-bottom:1.5rem">Select a plan and complete payment via MTN Momo or ATM card </p>

    <div class="plans-grid">
      <div class="plan">
        <h3>Basic</h3>
        <p>Free tier  access limited tutorials.</p>
        <div class="pay-methods">
          <button class="pay-btn momo" onclick="continueBasic()" style="flex: 1; background: linear-gradient(135deg, #009B3A, #FFCD00); color: #000; width: 100%;">Continue</button>
        </div>
      </div>

        <div class="plan">
          <h3>Gold</h3>
          <p>$10   extended tutorials and priority support.</p>
          <div class="pay-methods">
            <button class="pay-btn momo" data-plan="gold" onclick="openMomoModal('gold')">Pay with MTN Momo</button>
            <button class="pay-btn card" data-plan="gold">Pay with Card</button>
          </div>
        </div>

      <div class="plan">
        <h3>Diamond</h3>
        <p>$100  all features + personal coaching.</p>
        <div class="pay-methods">
          <button class="pay-btn momo" data-plan="diamond" onclick="openMomoModal('diamond')">Pay with MTN Momo</button>
          <button class="pay-btn card" data-plan="diamond">Pay with Card</button>
        </div>
      </div>
    </div>

    <div id="status" style="margin-top:1.5rem;color:#FFCD00"></div>
  </main>


 
  </div>
  <script>
    function continueBasic() {
      // Store basic plan in localStorage
      localStorage.setItem('rc_plan', 'basic');
      // Redirect immediately to tutorials without prompt
      window.location.href = 'tutorials.html';
    }

    // Simple demo/payment simulation
    document.querySelectorAll('.pay-btn.momo').forEach(btn=>btn.addEventListener('click', (e)=>{
      const plan = e.target.dataset.plan;
      const number = prompt('Enter your MTN Momo phone number (e.g. 2507xxxxxxx)');
      if(!number) return;
      document.getElementById('status').textContent = 'Initiating MTN Momo payment for '+plan+'... (demo)';
      setTimeout(()=>{
        document.getElementById('status').textContent = 'Payment successful! Thank you. Plan '+plan+' activated. Redirecting to Quiz...';
        // store purchase locally
        localStorage.setItem('rc_plan', plan);
          // redirect to appropriate page based on plan
          const redirectUrl = plan === 'diamond' ? 'schedule.html' : 'quiz.html';
        setTimeout(() => {
            window.location.href = redirectUrl;
        }, 1500);
      },2000);
    }));

    document.querySelectorAll('.pay-btn.card').forEach(btn=>btn.addEventListener('click', (e)=>{
      const plan = e.target.dataset.plan;
      const card = prompt('Enter mock card number (16 digits)');
      if(!card) return;
      if(card.length<12){ alert('Invalid card number for demo.'); return; }
      document.getElementById('status').textContent = 'Processing card payment for '+plan+'... (demo)';
      setTimeout(()=>{
        document.getElementById('status').textContent = 'Card payment successful! Plan '+plan+' activated. Redirecting to Quiz...';
        localStorage.setItem('rc_plan', plan);
          // redirect to appropriate page based on plan
          const redirectUrl = plan === 'diamond' ? 'schedule.html' : 'quiz.html';
        setTimeout(() => {
            window.location.href = redirectUrl;
        }, 1500);
      },2200);
    }));

    
    const user = localStorage.getItem('rc_user');
    if(!user){
      
      window.location.href = 'login.html';
    }

    // --- MTN Momo modal & flow (frontend demo that talks to local /momo-server)
    let momoTargetPlan = null;
    function openMomoModal(plan){
      momoTargetPlan = plan;
      document.getElementById('momoMsg').textContent = '';
      document.getElementById('momoMsisdn').value = '';
      document.getElementById('momoModal').style.display = 'flex';
    }
    function closeMomoModal(){ document.getElementById('momoModal').style.display = 'none'; }

    async function submitMomoPayment(){
      const msisdn = document.getElementById('momoMsisdn').value.trim();
      if(!/^[0-9]{8,15}$/.test(msisdn)){
        document.getElementById('momoMsg').textContent = 'Please enter a valid msisdn (digits only)';
        return;
      }
      // Format to international if needed (example for Rwanda: ensure starts with 250)
      let formatted = msisdn;
      if(!formatted.startsWith('250')){
        // user might enter 07XXXXXXXX, convert
        if(formatted.startsWith('0')) formatted = '250' + formatted.slice(1);
      }

      document.getElementById('momoMsg').textContent = 'Sending payment prompt to ' + formatted + '...';

      try{
        const resp = await fetch('http://localhost:3000/api/momo/request', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ msisdn: formatted, amount: momoTargetPlan==='diamond'?100:10 })
        });
        const data = await resp.json();
        if(!resp.ok) throw data;
        document.getElementById('momoMsg').textContent = 'Prompt sent. Waiting for confirmation...';
        // Auto-approve for demo (simulate MTN callback)
        fetch('http://localhost:3000/api/momo/test-approve/' + data.referenceId, {method:'POST'}).catch(e=>console.error(e));
        // poll for status
        pollMomoStatus(data.referenceId, momoTargetPlan);
      }catch(err){
        console.error(err);
        document.getElementById('momoMsg').textContent = 'Failed to send prompt: ' + (err.error || err.message || JSON.stringify(err));
      }
    }

    async function pollMomoStatus(referenceId, plan){
      const statusEl = document.getElementById('momoMsg');
      let attempts = 0;
      const interval = setInterval(async ()=>{
        attempts++;
        try{
          const r = await fetch('http://localhost:3000/api/momo/status/' + referenceId);
          if(r.status===200){
            const obj = await r.json();
            statusEl.textContent = 'Status: ' + obj.status;
            if(obj.status === 'SUCCESS' || obj.status === 'SUCCESSFUL' || obj.status === 'COMPLETED'){
              clearInterval(interval);
              localStorage.setItem('rc_plan', plan);
              statusEl.textContent = 'Payment successful! Plan activated.';
              setTimeout(()=> window.location.href = plan==='diamond'? 'schedule.html' : 'quiz.html', 1200);
            } else if(obj.status === 'FAILED' || obj.status === 'REJECTED'){
              clearInterval(interval);
              statusEl.textContent = 'Payment was declined or failed.';
            }
          } else if(attempts > 30){
            clearInterval(interval);
            statusEl.textContent = 'Timed out waiting for confirmation. Please try again later.';
          }
        }catch(e){
          console.error('poll error', e);
          if(attempts>30){ clearInterval(interval); statusEl.textContent = 'Network error while polling.'; }
        }
      }, 2500);
    }

    // Redirect to login.html if not logged in
    if (!localStorage.getItem('rc_user')) {
      window.location.href = 'login.html';
    }
  </script>

  <div class="copyright">
    Copyright Â© 2025 SHEMA Ian. All Rights Reserved.
  </div>
</body>
</html>